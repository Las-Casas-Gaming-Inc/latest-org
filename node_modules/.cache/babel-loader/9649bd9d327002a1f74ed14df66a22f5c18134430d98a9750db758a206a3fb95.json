{"ast":null,"code":"import getFamilyLoops from '../../algorithms/getFamilyLoops';\nimport FamilyItem from '../../models/FamilyItem';\nimport { GroupByType } from '../../enums';\nexport default function RemoveLoopsTask(logicalFamilyTask) {\n  var _data = {\n    logicalFamily: null,\n    maximumId: null,\n    loops: [] // populate collection of pairs between fake parents and fake children\n  };\n  function process(debug) {\n    var logicalFamily = logicalFamilyTask.getLogicalFamily(),\n      maximumId = logicalFamilyTask.getMaximumId();\n    var result = removeLoops(logicalFamily, maximumId, debug);\n    _data.logicalFamily = result.logicalFamily;\n    _data.maximumId = result.maximumId;\n    _data.loops = result.loops;\n    if (debug && !logicalFamily.validate()) {\n      throw \"References are broken in family structure!\";\n    }\n    return true;\n  }\n  function removeLoops(logicalFamily, maximumId, debug) {\n    var fakeChild,\n      fakeParent,\n      index,\n      len,\n      index2,\n      len2,\n      edgesToReverse = getFamilyLoops(logicalFamily, debug),\n      fakePairs = [];\n\n    /* group edges by child node */\n    var loops = [];\n    var loopsHash = {};\n    for (index = 0, len = edgesToReverse.length; index < len; index += 1) {\n      var edge = edgesToReverse[index];\n      if (!loopsHash.hasOwnProperty(edge.to)) {\n        loopsHash[edge.to] = {\n          itemid: edge.to,\n          parents: [edge.from]\n        };\n        loops.push(loopsHash[edge.to]);\n      } else {\n        loopsHash[edge.to].parents.push(edge.from);\n      }\n    }\n    var fakeChildren = {}; // reuse fake children across removed edges\n    if (loops.length > 0) {\n      logicalFamily = logicalFamily.clone();\n      for (index = 0, len = loops.length; index < len; index += 1) {\n        var loop = loops[index];\n        var parents = loop.parents;\n        var itemParents = [];\n        logicalFamily.loopParents(this, loop.itemid, function (parentid, parent) {\n          itemParents.push(parentid);\n          return logicalFamily.SKIP;\n        });\n        for (index2 = 0, len2 = itemParents.length; index2 < len2; index2 += 1) {\n          /* remove relation in temp structure */\n          logicalFamily.removeChildRelation(itemParents[index2], loop.itemid);\n        }\n\n        /* create fake parent and child items to loop item to its parent */\n        maximumId += 1;\n        var isConnectionsVisible = itemParents.length <= parents.length;\n        /* add fake parent */\n        fakeParent = new FamilyItem({\n          id: maximumId,\n          isVisible: false,\n          isActive: false,\n          isLevelNeutral: false,\n          hideParentConnection: isConnectionsVisible,\n          hideChildrenConnection: isConnectionsVisible,\n          levelGravity: GroupByType.Children,\n          itemConfig: {\n            title: \"fake parent #\" + maximumId,\n            description: \"This is a fake parent item, it was created by loops removal task.\"\n          }\n        });\n        logicalFamily.add([], fakeParent.id, fakeParent);\n        logicalFamily.adopt([fakeParent.id], loop.itemid);\n        fakePairs.push({\n          from: fakeParent.id,\n          to: loop.itemid,\n          isOppositeFlow: false\n        });\n        for (index2 = 0, len2 = parents.length; index2 < len2; index2 += 1) {\n          var parentid = parents[index2];\n          fakeChild = fakeChildren[parentid];\n          if (fakeChild == null) {\n            /* add fake child */\n            maximumId += 1;\n            fakeChild = new FamilyItem({\n              id: maximumId,\n              isVisible: false,\n              isActive: false,\n              isLevelNeutral: false,\n              hideParentConnection: true,\n              hideChildrenConnection: true,\n              levelGravity: GroupByType.Parents,\n              itemConfig: {\n                title: \"fake child #\" + maximumId,\n                description: \"This is a fake child item, it was created by loops removal task.\"\n              }\n            });\n            fakeChildren[parentid] = fakeChild;\n            logicalFamily.add([parentid], fakeChild.id, fakeChild);\n            fakePairs.push({\n              from: parentid,\n              to: fakeChild.id,\n              isOppositeFlow: false\n            });\n          }\n          logicalFamily.adopt([fakeParent.id], fakeChild.id);\n          fakePairs.push({\n            from: fakeParent.id,\n            to: fakeChild.id,\n            isOppositeFlow: true\n          });\n        }\n\n        // assign remaining parents of our item to the fake parent\n        var parentsHash = {};\n        for (index2 = 0, len2 = parents.length; index2 < len2; index2 += 1) {\n          parentsHash[parents[index2]] = true;\n        }\n        for (index2 = 0, len2 = itemParents.length; index2 < len2; index2 += 1) {\n          if (!parentsHash.hasOwnProperty(itemParents[index2])) {\n            logicalFamily.adopt([itemParents[index2]], fakeParent.id);\n          }\n        }\n      }\n    }\n    return {\n      maximumId: maximumId,\n      logicalFamily: logicalFamily,\n      loops: fakePairs\n    };\n  }\n  function getLogicalFamily() {\n    return _data.logicalFamily;\n  }\n  function getMaximumId() {\n    return _data.maximumId;\n  }\n  function getLoops() {\n    return _data.loops;\n  }\n  return {\n    process: process,\n    getLogicalFamily: getLogicalFamily,\n    getMaximumId: getMaximumId,\n    getLoops: getLoops\n  };\n}\n;","map":{"version":3,"names":["getFamilyLoops","FamilyItem","GroupByType","RemoveLoopsTask","logicalFamilyTask","_data","logicalFamily","maximumId","loops","process","debug","getLogicalFamily","getMaximumId","result","removeLoops","validate","fakeChild","fakeParent","index","len","index2","len2","edgesToReverse","fakePairs","loopsHash","length","edge","hasOwnProperty","to","itemid","parents","from","push","fakeChildren","clone","loop","itemParents","loopParents","parentid","parent","SKIP","removeChildRelation","isConnectionsVisible","id","isVisible","isActive","isLevelNeutral","hideParentConnection","hideChildrenConnection","levelGravity","Children","itemConfig","title","description","add","adopt","isOppositeFlow","Parents","parentsHash","getLoops"],"sources":["C:/Users/LCGI_15/Desktop/projects/nesty-orgchart/orgchart/node_modules/basicprimitives/src/tasks/transformations/RemoveLoopsTask.js"],"sourcesContent":["import getFamilyLoops from '../../algorithms/getFamilyLoops';\r\nimport FamilyItem from '../../models/FamilyItem';\r\nimport { GroupByType } from '../../enums';\r\n\r\nexport default function RemoveLoopsTask(logicalFamilyTask) {\r\n  var _data = {\r\n    logicalFamily: null,\r\n    maximumId: null,\r\n    loops: [] // populate collection of pairs between fake parents and fake children\r\n  };\r\n\r\n  function process(debug) {\r\n    var logicalFamily = logicalFamilyTask.getLogicalFamily(),\r\n      maximumId = logicalFamilyTask.getMaximumId();\r\n\r\n    var result = removeLoops(logicalFamily, maximumId, debug);\r\n\r\n    _data.logicalFamily = result.logicalFamily;\r\n    _data.maximumId = result.maximumId;\r\n    _data.loops = result.loops;\r\n\r\n    if (debug && !logicalFamily.validate()) {\r\n      throw \"References are broken in family structure!\";\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function removeLoops(logicalFamily, maximumId, debug) {\r\n    var fakeChild, fakeParent,\r\n      index, len,\r\n      index2, len2,\r\n      edgesToReverse = getFamilyLoops(logicalFamily, debug),\r\n      fakePairs = [];\r\n\r\n    /* group edges by child node */\r\n    var loops = [];\r\n    var loopsHash = {};\r\n    for (index = 0, len = edgesToReverse.length; index < len; index += 1) {\r\n      var edge = edgesToReverse[index];\r\n\r\n      if (!loopsHash.hasOwnProperty(edge.to)) {\r\n        loopsHash[edge.to] = { itemid: edge.to, parents: [edge.from] };\r\n        loops.push(loopsHash[edge.to]);\r\n      } else {\r\n        loopsHash[edge.to].parents.push(edge.from);\r\n      }\r\n    }\r\n\r\n    var fakeChildren = {}; // reuse fake children across removed edges\r\n    if (loops.length > 0) {\r\n      logicalFamily = logicalFamily.clone();\r\n      for (index = 0, len = loops.length; index < len; index += 1) {\r\n        var loop = loops[index];\r\n        var parents = loop.parents;\r\n\r\n        var itemParents = [];\r\n        logicalFamily.loopParents(this, loop.itemid, function (parentid, parent) {\r\n          itemParents.push(parentid);\r\n          return logicalFamily.SKIP;\r\n        });\r\n\r\n        for (index2 = 0, len2 = itemParents.length; index2 < len2; index2 += 1) {\r\n          /* remove relation in temp structure */\r\n          logicalFamily.removeChildRelation(itemParents[index2], loop.itemid);\r\n        }\r\n\r\n        /* create fake parent and child items to loop item to its parent */\r\n        maximumId += 1;\r\n\r\n        var isConnectionsVisible = (itemParents.length <= parents.length);\r\n        /* add fake parent */\r\n        fakeParent = new FamilyItem({\r\n          id: (maximumId),\r\n          isVisible: false,\r\n          isActive: false,\r\n          isLevelNeutral: false,\r\n          hideParentConnection: isConnectionsVisible,\r\n          hideChildrenConnection: isConnectionsVisible,\r\n          levelGravity: GroupByType.Children,\r\n          itemConfig: { title: \"fake parent #\" + maximumId, description: \"This is a fake parent item, it was created by loops removal task.\" }\r\n        });\r\n\r\n        logicalFamily.add([], fakeParent.id, fakeParent);\r\n        logicalFamily.adopt([fakeParent.id], loop.itemid);\r\n        fakePairs.push({ from: fakeParent.id, to: loop.itemid, isOppositeFlow: false });\r\n\r\n        for (index2 = 0, len2 = parents.length; index2 < len2; index2 += 1) {\r\n          var parentid = parents[index2];\r\n\r\n          fakeChild = fakeChildren[parentid];\r\n\r\n          if (fakeChild == null) {\r\n            /* add fake child */\r\n            maximumId += 1;\r\n            fakeChild = new FamilyItem({\r\n              id: (maximumId),\r\n              isVisible: false,\r\n              isActive: false,\r\n              isLevelNeutral: false,\r\n              hideParentConnection: true,\r\n              hideChildrenConnection: true,\r\n              levelGravity: GroupByType.Parents,\r\n              itemConfig: { title: \"fake child #\" + maximumId, description: \"This is a fake child item, it was created by loops removal task.\" }\r\n            });\r\n            fakeChildren[parentid] = fakeChild;\r\n\r\n            logicalFamily.add([parentid], fakeChild.id, fakeChild);\r\n            fakePairs.push({ from: parentid, to: fakeChild.id, isOppositeFlow: false });\r\n          }\r\n\r\n          logicalFamily.adopt([fakeParent.id], fakeChild.id);\r\n          fakePairs.push({ from: fakeParent.id, to: fakeChild.id, isOppositeFlow: true });\r\n\r\n        }\r\n\r\n        // assign remaining parents of our item to the fake parent\r\n        var parentsHash = {};\r\n        for (index2 = 0, len2 = parents.length; index2 < len2; index2 += 1) {\r\n          parentsHash[parents[index2]] = true;\r\n        }\r\n        for (index2 = 0, len2 = itemParents.length; index2 < len2; index2 += 1) {\r\n          if (!parentsHash.hasOwnProperty(itemParents[index2])) {\r\n            logicalFamily.adopt([itemParents[index2]], fakeParent.id);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return {\r\n      maximumId: maximumId,\r\n      logicalFamily: logicalFamily,\r\n      loops: fakePairs\r\n    }\r\n  }\r\n\r\n  function getLogicalFamily() {\r\n    return _data.logicalFamily;\r\n  }\r\n\r\n  function getMaximumId() {\r\n    return _data.maximumId;\r\n  }\r\n\r\n  function getLoops() {\r\n    return _data.loops;\r\n  }\r\n\r\n  return {\r\n    process: process,\r\n    getLogicalFamily: getLogicalFamily,\r\n    getMaximumId: getMaximumId,\r\n    getLoops: getLoops\r\n  };\r\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}